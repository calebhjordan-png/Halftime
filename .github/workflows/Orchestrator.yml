name: Orchestrator

on:
  workflow_dispatch:
    inputs:
      league:
        description: "League"
        type: choice
        required: true
        default: both
        options: [both, nfl, college-football]
      game_ids:
        description: "Game IDs"
        required: false
        default: ""

concurrency:
  group: orchestrator-${{ github.run_id }}
  cancel-in-progress: false

env:
  GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
  GOOGLE_SERVICE_ACCOUNT: ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}
  TZ: America/New_York
  ADAPTIVE_HALFTIME: "1"            # always on
  GAME_IDS: ${{ inputs.game_ids }}

jobs:
  run-nfl:
    if: ${{ inputs.league == 'both' || inputs.league == 'nfl' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: |
          npm install --no-audit --no-fund
          npx playwright install --with-deps chromium

      - name: Decide RUN_SCOPE (ET)
        run: |
          # Mon=1..Sun=7 ; Fri/Sat/Sun => today, else week
          DOW=$(date +%u)
          if [ "$DOW" -ge 5 ]; then SCOPE=today; else SCOPE=week; fi
          echo "RUN_SCOPE=$SCOPE" >> "$GITHUB_ENV"

      - name: Run orchestrator (NFL)
        env:
          LEAGUE: nfl
        run: node orchestrator.mjs

  run-cfb:
    if: ${{ inputs.league == 'both' || inputs.league == 'college-football' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: |
          npm install --no-audit --no-fund
          npx playwright install --with-deps chromium

      - name: Decide RUN_SCOPE (ET)
        run: |
          DOW=$(date +%u)
          if [ "$DOW" -ge 5 ]; then SCOPE=today; else SCOPE=week; fi
          echo "RUN_SCOPE=$SCOPE" >> "$GITHUB_ENV"

      - name: Run orchestrator (CFB)
        env:
          LEAGUE: college-football
        run: node orchestrator.mjs
