name: "ðŸŽ“ CFB Live (Hourly + Smart 5-Minute Loop)"

on:
  workflow_dispatch:
    inputs:
      force_five:
        description: "Force 5-minute loop (debug)"
        required: false
        default: "false"
  schedule:
    # top of every hour; the gate script decides whether to loop every 5 minutes
    - cron: "0 * * * *"

permissions:
  contents: read
  actions: write   # needed so we can self-dispatch for the 5-minute loop

concurrency:
  group: cfb-live
  cancel-in-progress: true

jobs:
  live:
    runs-on: ubuntu-latest
    env:
      # Keep league/tab here; live-game.mjs reads these
      LEAGUE: college-football
      TAB_NAME: CFB

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: npm ci

      # â”€â”€ Gate: decide if we should enter 5-minute loop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Runs the gate script (ET window + â€œpre-3rdâ€ check), captures JSON
      # safely, and exposes it via steps.gate.outputs.json for fromJSON(...)
      - name: Gate (ET window + pre-3rd check)
        id: gate
        env:
          LEAGUE: college-football
        run: |
          node live-gate.mjs > gate.json
          # flatten to single line and escape for GitHub Outputs
          ONE=$(tr -d '\n' < gate.json)
          ONE=${ONE//'%'/'%25'}
          ONE=${ONE//$'\r'/'%0D'}
          ONE=${ONE//$'\n'/'%0A'}
          echo "json=${ONE}" >> "$GITHUB_OUTPUT"

      - name: Debug gate
        run: |
          echo "Gate JSON: ${{ steps.gate.outputs.json }}"
          echo "shouldLoop: ${{ fromJSON(steps.gate.outputs.json).shouldLoop }}"
          echo "reason    : ${{ fromJSON(steps.gate.outputs.json).reason }}"

      # â”€â”€ Run the live updater (always runs) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run live updater (CFB)
        env:
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          GOOGLE_SERVICE_ACCOUNT: ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}
          LEAGUE: college-football
          TAB_NAME: CFB
          # Keep DEBUG_MODE blank by default
          DEBUG_MODE: "0"
        run: node live-game.mjs

      # â”€â”€ 5-minute self-dispatch when any CFB game is live (pre-3rd) â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Conditional requeue (5-min loop if live games)
        if: ${{ fromJSON(steps.gate.outputs.json).shouldLoop || github.event.inputs.force_five == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }} # PAT with 'workflow' scope
        run: |
          # Re-dispatch THIS workflow on the same branch
          gh workflow run "ðŸŽ“ CFB Live (Hourly + Smart 5-Minute Loop)" \
            -r ${{ github.ref_name }}
          echo "Requeued 5-minute loop. reason='${{ fromJSON(steps.gate.outputs.json).reason }}' force='${{ github.event.inputs.force_five }}'"
