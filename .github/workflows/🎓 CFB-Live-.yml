name: ðŸŽ“ CFB Live

on:
  workflow_dispatch:
  schedule:
    # Top of every hour, 10:00â€“23:00 and 00:00â€“01:00 ET
    - cron: "0 10-23 * * *"
    - cron: "0 0-1 * * *"
    # Every 5 minutes in the same ET window (gated by live-gate)
    - cron: "*/5 10-23 * * *"
    - cron: "*/5 0-1 * * *"
  timezone: America/New_York

permissions:
  contents: read

concurrency:
  group: cfb-live-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: npm i axios googleapis

      # Gate only for the 5-minute schedules. For hourly, always run.
      - name: Gate for 5-minute cycle
        id: gate
        env:
          LEAGUE: college-football
        run: |
          # Detect whether this is a 5-minute schedule by minute not equal 0
          now_min=$(TZ=America/New_York date +%M)
          if [ "$now_min" != "00" ]; then
            node ops/live-gate.mjs > gate.log || true
            cat gate.log
            v=$(grep -Eo 'run_updater=(true|false)' gate.log | cut -d= -f2)
            echo "run_updater=${v:-false}" >> $GITHUB_OUTPUT
          else
            echo "run_updater=true" >> $GITHUB_OUTPUT
          fi

      - name: Run live updater (CFB)
        if: steps.gate.outputs.run_updater == 'true'
        env:
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          GOOGLE_SERVICE_ACCOUNT: ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}
          LEAGUE: "college-football"
          TAB_NAME: "CFB"
        run: node live-game.mjs
