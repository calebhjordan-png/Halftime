name: ðŸŽ“ CFB Live (Hourly + Smart 5-Minute Loop)

on:
  workflow_dispatch:
  repository_dispatch:
    types: [cfb_live_requeue]
  schedule:
    - cron: "0 10-23 * * *"   # 10AMâ€“11PM ET hourly
    - cron: "0 0-2 * * *"     # Midnightâ€“2AM ET hourly

jobs:
  live:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: npm i axios googleapis

      - name: Run CFB live updater
        env:
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          GOOGLE_SERVICE_ACCOUNT: ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}
          LEAGUE: "college-football"
          TAB_NAME: "CFB"
          DEBUG_MODE: "0"
        run: node live-game.mjs

      - name: Conditional requeue (5-min loop if live games)
        if: success()
        env:
          GH_PAT_WORKFLOW: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          node - <<'JS'
          import axios from "axios";
          const fs = await import("fs");
          const txt = fs.readFileSync("live-game.mjs", "utf8");
          const hasLive = txt.includes("In Progress") || txt.includes("Q1") || txt.includes("Q2");
          if (hasLive) {
            console.log("Detected live games â€” scheduling requeue in 5m.");
            const delay = 5 * 60 * 1000;
            setTimeout(async () => {
              await axios.post(
                "https://api.github.com/repos/${{ github.repository }}/dispatches",
                { event_type: "cfb_live_requeue" },
                { headers: { Authorization: `token ${{ secrets.GH_PAT_WORKFLOW }}` } }
              );
            }, delay);
          } else {
            console.log("No live games â€” remain hourly.");
          }
          JS
