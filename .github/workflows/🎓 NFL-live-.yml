name: "ðŸŽ“ NFL Live (Hourly + Smart 5-Minute Loop)"

on:
  workflow_dispatch:
    inputs:
      force_five:
        description: "Force 5-minute loop (debug)"
        required: false
        default: "false"
  schedule:
    # Top of every hour. Window gating below (ET 10:00â€“01:59) decides whether to continue.
    - cron: "0 * * * *"

permissions:
  contents: read
  actions: write

concurrency:
  group: nfl-live
  cancel-in-progress: false

jobs:
  live:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Set up job
        run: echo "NFL live updater startingâ€¦"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: |
          # keep it simple and robust across lock changes
          npm install --no-fund --no-audit
        env:
          CI: "true"

      # Only run between 10:00â€“01:59 ET (manual dispatch always allowed)
      - name: Hour window guard (ET 10:00â€“01:59)
        id: window
        shell: bash
        run: |
          ET_HOUR=$(TZ=America/New_York date +%H)
          if [ "$ET_HOUR" -ge 10 ] || [ "$ET_HOUR" -le 01 ]; then
            echo "run_now=true" >> "$GITHUB_OUTPUT"
            echo "Within allowed window (ET hour=$ET_HOUR)."
          else
            echo "run_now=false" >> "$GITHUB_OUTPUT"
            echo "Outside window (ET hour=$ET_HOUR)."
          fi

      - name: Run NFL live updater
        if: steps.window.outputs.run_now == 'true' || github.event_name == 'workflow_dispatch'
        shell: bash
        env:
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          GOOGLE_SERVICE_ACCOUNT: ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}
          LEAGUE: nfl
          TAB_NAME: NFL
          DEBUG_MODE: "0"
        run: |
          node live-game.mjs

      # Decide whether we should requeue in 5 minutes (any live game pre-3rd?)
      - name: Conditional requeue (5-min loop if live games)
        id: gate
        if: steps.window.outputs.run_now == 'true' || github.event_name == 'workflow_dispatch'
        shell: bash
        env:
          FORCE_FIVE: ${{ inputs.force_five }}
          LEAGUE: nfl
        run: |
          node orchestrator.mjs > gate.json
          echo "Gate payload:"
          cat gate.json
          SHOULD=$(node -e "console.log(JSON.parse(require('fs').readFileSync('gate.json','utf8')).shouldLoop ? 'true':'false')")
          echo "should_loop=$SHOULD" >> "$GITHUB_OUTPUT"

      - name: Sleep 5 minutes when pre-3rd games exist
        if: steps.gate.outputs.should_loop == 'true'
        run: |
          echo "Sleeping 300sâ€¦"
          sleep 300

      - name: Re-queue workflow (self-dispatch)
        if: steps.gate.outputs.should_loop == 'true'
        env:
          GH_PAT: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          echo "Re-dispatching NFL Live for another 5-minute cycleâ€¦"
          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_PAT}" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/NFL-Live.yml/dispatches \
            -d '{"ref":"main","inputs":{"force_five":"false"}}'
