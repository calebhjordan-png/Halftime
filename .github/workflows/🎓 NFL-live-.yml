name: "🏈 NFL Live (Hourly + Smart 5-Minute Loop)"

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"   # hourly

jobs:
  live:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: |
          npm init -y >/dev/null 2>&1 || true
          npm i googleapis playwright
          npx playwright install --with-deps chromium

      - name: Run NFL live updater
        id: updater
        env:
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          GOOGLE_SERVICE_ACCOUNT: ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}
          LEAGUE: nfl
          TAB_NAME: NFL
          RUN_SCOPE: week
          ADAPTIVE_HALFTIME: "1"
          GHA_JSON: "1"
        shell: bash
        run: |
          json="$(node orchestrator.mjs --gha)"
          echo "result=${json}" >> "$GITHUB_OUTPUT"

      - name: Gate for 5-minute cycle (NFL)
        id: gate
        env:
          LEAGUE: nfl
          DEBUG_MODE: "0"
          GHA_JSON: "1"
        shell: bash
        run: node live-gate.mjs --gha

      - name: Read gate decision
        shell: bash
        run: echo "FAST=${{ steps.gate.outputs.FAST }}"

      - name: Conditional requeue (5-min loop if live games)
        if: ${{ steps.gate.outputs.FAST == '1' }}
        shell: bash
        run: |
          echo "Re-queuing in 5 minutes because there are pre-3rd/halftime games."
          # Your requeue action goes here (e.g., schedule another run via API or a delay+re-run pattern)
