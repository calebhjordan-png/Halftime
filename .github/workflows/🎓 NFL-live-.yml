name: "ðŸŽ“ NFL Live"

on:
  workflow_dispatch:
    inputs:
      game_id:
        description: "Optional ESPN game id to focus on"
        required: false
        default: ""
      debug:
        description: "Enable verbose debug logging"
        required: false
        default: "0"
  schedule:
    # ET window only (10:00 â†’ 01:59, pinned with TZ below)
    - cron: "0 10-23 * * *"
    - cron: "0 0-1 * * *"
    - cron: "*/5 10-23 * * *"
    - cron: "*/5 0-1 * * *"

env:
  TZ: America/New_York
  LEAGUE: nfl
  TAB_NAME: NFL

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: npm i axios googleapis

      - name: Scan ESPN for live (â‰¤ HT) games
        id: scan
        env:
          ESPN_SPORT: football
          ESPN_LEAGUE: nfl
        shell: bash
        run: |
          set -euo pipefail
          SCHED="${{ github.event.schedule || '' }}"
          echo "schedule_fired=$SCHED" >> "$GITHUB_OUTPUT"
          echo "live=false" >> "$GITHUB_OUTPUT"
          echo "ids="       >> "$GITHUB_OUTPUT"

          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.game_id }}" ]]; then
            echo "live=true"        >> "$GITHUB_OUTPUT"
            echo "ids=${{ github.event.inputs.game_id }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          URL="https://site.api.espn.com/apis/site/v2/sports/${ESPN_SPORT}/${ESPN_LEAGUE}/scoreboard"
          curl -sS "$URL" > /tmp/scoreboard.json

          IDS=$(jq -r '
            .events[]
            | select(.status.type.state=="in")
            | select((.status.period|tonumber) <= 2 or (.status.type.description|ascii_downcase|test("halftime")))
            | .id
          ' /tmp/scoreboard.json | tr '\n' ' ' | sed 's/  */ /g' | sed 's/[[:space:]]$//')

          if [[ -n "$IDS" ]]; then
            echo "Live (â‰¤HT) game IDs: $IDS"
            echo "live=true" >> "$GITHUB_OUTPUT"
            echo "ids=$IDS"  >> "$GITHUB_OUTPUT"
          else
            echo "No NFL games live at or before halftime."
          fi

      - name: Decide to run updater
        id: decide
        shell: bash
        run: |
          set -euo pipefail
          SCHED="${{ steps.scan.outputs.schedule_fired }}"
          LIVE="${{ steps.scan.outputs.live }}"
          RUN="no"

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            RUN="yes"
          elif [[ "$SCHED" =~ ^0[[:space:]] ]]; then
            RUN="yes"
          else
            [[ "$LIVE" == "true" ]] && RUN="yes"
          fi

          echo "run_updater=$RUN" >> "$GITHUB_OUTPUT"
          echo "ids=${{ steps.scan.outputs.ids }}" >> "$GITHUB_OUTPUT"
          echo "Decision: $RUN"

      - name: Run live updater (NFL)
        if: steps.decide.outputs.run_updater == 'yes'
        env:
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          GOOGLE_SERVICE_ACCOUNT: ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}
          LEAGUE: ${{ env.LEAGUE }}
          TAB_NAME: ${{ env.TAB_NAME }}
          DEBUG_MODE: ${{ github.event.inputs.debug || '0' }}
        shell: bash
        run: |
          set -euo pipefail
          IDS="${{ steps.decide.outputs.ids }}"
          if [[ -n "$IDS" ]]; then
            for id in $IDS; do
              echo "â†’ Updating focused game $id"
              GAME_ID="$id" node live-game.mjs
            done
          else
            echo "â†’ General pass (no focused IDs)"
            node live-game.mjs
          fi
